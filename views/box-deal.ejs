<%- include ('partials/header') -%>
    <section>
        <div class="row header">
            <div class="container">
                <div class="col-sm-6 col-sm-push-6 column img-container">
                    <img src="<%= box.image ? box.image.url : '' %>" style="" alt="">
                </div>
                <div class="col-sm-6 col-sm-pull-6 column text-container">
                    <div class="text-content">
                        <h1><%= box.name %> Box</h1><br>
                        <%_ if (box.price_sale && !is_ambassador) { _%>
                        <p style="font-size: 1.5em; color: rgba(240, 230, 140); margin-top: -1em">
                            £<%- (box.price_sale / 100).toFixed(2) %> <small><del>£<%- (box.price / 100).toFixed(2) %></del></small>
                        </p><br>
                        <%_ } if (box.info) { _%>
                        <p><%- box.info.replace(/\r?\n/g, "<br>") %></p><br>
                        <%_ }_%>
                        <p>Click the images below to choose</p><br>
                        <p><i class="dropdown-arrow fal fa-chevron-down" style="font-size: 3em"></i></p>
                    </div>
                </div>
            </div>
        </div>
        <br><br>

        <div class="container" style="padding-left: 0; padding-right: 0;">
            <form class="panel-group minimal" action="/deal/cart/add">
                <%_ var groups = products.map(p => p.product_collection || p.category);
                    products.forEach((product, i, arr) => {
                    if (groups[i] && (i === 0 || groups[i] !== groups[i-1])) { _%>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h2 class="panel-title collapsed" data-toggle="collapse" data-target="#collapse<%= i %>">
                            <i class="fal fa-chevron-down dropdown-arrow" style="margin-right: 5px;"></i>
                            <%= product.product_collection ? product.product_collection + " Collection" : product.category.charAt(0).toUpperCase() + product.category.slice(1) %>
                        </h2>
                    </div>
                    <div id="collapse<%= i %>" class="panel-collapse collapse">
                        <div class="panel-body">
                            <div class="thumb-container">
                                <div class="container">
                                    <div class="row">
                                        <%_ products.filter(p => p.product_collection ? p.product_collection === product.product_collection : p.category === product.category).forEach(p => { _%>
                                        <div class="thumb col-md-3 col-sm-4">
                                            <div class="thumb-inner">
                                                <div class="thumb-img product-image" style="background-image: url('<%- p.image ? p.image.url : '' %>');">
                                                    <input type="checkbox" name="product_id" value="<%= p.id %>" <%- p.stock_qty > 0 ? '' : 'disabled' %>>
                                                </div>
                                                <div class="thumb-info">
                                                    <div class="product-name"><p><%= p.name %></p></div>
                                                    <%_ if (p.stock_qty > 0) { _%>
                                                    <div class="quantity-wrapper">
                                                        <button type="button" class="quantity-control-btn" data-step="-1">-</button>
                                                        <input class="product-quantity" type="number" name="quantity" min="1" max="<%= p.stock_qty %>" value="1" disabled>
                                                        <button type="button" class="quantity-control-btn" data-step="1">+</button>
                                                    </div>
                                                    <%_ } else { _%>
                                                    <div class="sold-out-label">SOLD OUT</div>
                                                    <%_ } _%>
                                                </div>
                                            </div>
                                        </div>
                                        <%_ }) _%>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <%_ }}) _%>
                <br>
                <input type="hidden" name="box_id" value="<%= box.id %>" required>
                <input type="submit" id="submit-btn" value="ADD TO CART">
            </form>
        </div>
    </section>

    <script>
        $(window).on("load scroll resize", function() {
            var windowOffsetBottom = window.pageYOffset + window.innerHeight;
            var footerOffsetTop = $("footer").offset().top - parseFloat($("footer").css("margin-top"));
            var bottom = windowOffsetBottom >= footerOffsetTop + parseFloat($("footer").css("margin-top")) ? (window.innerHeight - (footerOffsetTop - window.pageYOffset))+"px" : "";
            $("#submit-btn").css("bottom", bottom);
        });

        $(".panel-collapse").on("shown.bs.collapse hidden.bs.collapse", function() {
            $(window).trigger("resize");
        });

        $("input[type=checkbox]").change(function() {
            $(this).closest(".thumb-img").toggleClass("checked", this.checked);
            $(this).closest(".thumb").find(".product-quantity").attr({ disabled: !this.checked, required: this.checked });
        });

        $("form").submit(function(e) {
            e.preventDefault();
            var form = this;
            var btnController = new submitBtnController(form);

            $.post(form.action, $(form).serializeArray(), function(item_count) {
                var $btn = $("#cart-icon").toggleClass("visible", item_count > 0);
                $("#cart-item-count").text(item_count);
                $btn.clone(true).insertAfter($btn).animate({ fontSize: "+=3em", opacity: "0" }, function() { $(this).remove() });
                $(".thumb-img").removeClass("checked");
                $(".product-quantity").attr({ disabled: true, required: false });
                e.target.reset();
            }).fail(function(err) {
                alert(err.responseText);
            }).always(function() {
                btnController.finish();
            });
        });
    </script>
<%- include ('partials/footer') -%>
