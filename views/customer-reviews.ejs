<%- include ('partials/header') -%>
    <section class="section-padding">
        <div class="textbody">
            <h1 style="margin-bottom: 1em">CUSTOMER REVIEWS</h1>

            <div id="stats">
                <div class="row">
                    <div class="col-sm-<%= reviews.length ? '4' : '12' %>">
                        <button id="review-submission-link-btn" class="submit" type="button" data-toggle="modal" data-target="#review-form-modal">WRITE A REVIEW</button>
                        <p style="text-align: center; margin-bottom: 2em">
                            <%= reviews.length %> REVIEW<%= reviews.length !== 1 ? "S" : "" %>
                        </p>
                        <div id="review-form-modal" class="modal fade in" role="dialog">
                            <div class="modal-icons">
                                <button type="button" class="close-view" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form method="post" action="/reviews/submit" id="new-review-form">
                                    <fieldset>
                                        <legend>WRITE A REVIEW</legend>

                                        <%_ if (!user) { _%>
                                        <label>YOUR NAME</label>
                                        <input type="text" name="author_name" required>

                                        <%_ } _%>
                                        <label>HEADLINE <span>(OPTIONAL)</span></label>
                                        <input type="text" name="headline">

                                        <label>RATING</label>
                                        <fieldset class="star-rating">
                                            <%_ for(i = 1; i <= 5; i++) { _%>
                                            <div class="col-xs-1 star">★<input type="radio" name="rating" value="<%= i %>" required></div>
                                            <%_ } _%>
                                        </fieldset>

                                        <label>YOUR COMMENT</label>
                                        <textarea name="commentry" rows="10" required></textarea>

                                        <label>PHOTOS <span>(OPTIONAL)</span></label>
                                        <fieldset class="file-upload-container">
                                            <div class="row">
                                                <div class="col-sm-6 col-xs-9"><input type="file" id="review_image_file" accept=".jpg,.jpeg,.png,.bmp" data-fieldname="image_file" multiple></div>
                                                <input type="hidden" name="image_file">
                                                <div class="col-sm-6 col-xs-3"><button type="button" class="clear-uploads" data-id="review_image_file">CLEAR</button></div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-12"><input type="url" name="image_url" id="review_image_url" placeholder="Or enter the image URL"></div>
                                            </div>
                                        </fieldset>

                                        <input type="submit" value="SUBMIT">
                                    </fieldset>
                                </form>
                            </div>
                        </div>
                    </div>
                    <%_ if (reviews.length) { _%>
                    <div class="col-sm-8">
                        <%_ for (i = 5; i >= 1; i--) {
                            const count = reviews.filter(r => r.rating == i).length;
                            const avg = count / reviews.length * 100; _%>
                        <div class="row">
                            <div class="col-sm-4 col-xs-5" style="text-align: right">
                                <%_ for(j = 1; j <= i; j++) { _%>
                                <span>★</span>
                                <%_ } _%>
                            </div>
                            <div class="col-xs-2" style="text-align: center; padding: 0">(<%= count %>)</div>
                            <div class="col-sm-6 col-xs-5">
                                <div class="rating-meter">
                                    <span><%= avg % 1 == 0 ? avg : avg.toFixed(1) %>%</span>
                                    <div class="bar" style="width: <%= avg %>%"></div>
                                </div>
                            </div>
                        </div>
                        <%_ } _%>
                    </div>
                    <%_ } _%>
                </div>
            </div>
            

            <div id="reviews">
                <%_ reviews.forEach(review => { _%>
                <div class="review">
                    <div class="author-icon">
                        <span><%= review.author_name.split(/[ -]/g).map(name => name.charAt(0)).join("").toUpperCase() %></span>
                    </div>
                    <div class="header">
                        <div class="row">
                            <div class="col-sm-8 headline">
                                <h2 class="title"><%= review.headline %></h2>
                            </div>
                            <div class="col-sm-4 rating">
                                <%_ for(i = 1; i <= review.rating; i++) { _%>
                                <span>★</span>
                                <%_ } _%>
                                <span style="font-size: .8em; opacity: .5">(<%= review.rating %>)</span>
                            </div>
                        </div>
                        <div class="row author-details">
                            <div class="col-sm-6 author-name">
                                <%= review.author_name %>
                                <%_ if (review.author_verified) { _%>
                                <i class="verified-badge fal fa-badge-check"></i>
                                <%_ } _%>
                            </div>
                            <div class="col-sm-6 post-date">
                                <%_ const day = review.created_at.getDate(); _%>
                                <%_ const month = review.created_at.getMonth() + 1; _%>
                                <%_ const year = review.created_at.getFullYear(); _%>
                                <%= `${ day < 10 ? "0"+day : day }/${ month < 10 ? "0"+month : month }/${ year }` %>
                            </div>
                        </div>
                    </div>
                    <%_ if (review.images.length) { _%>
                    <div class="images">
                        <%_ review.images.forEach(img => { _%>
                        <img src="<%- img.url %>" alt="<%- img.url %>" data-toggle="modal" data-target="#image-lg-modal">
                        <%_ }) _%>
                    </div>
                    <%_ } _%>
                    <div class="comment"><p><%- review.commentry.replace(/\r?\n/g, "</p><p>") %></p></div>
                </div>
                <%_ }) _%>
            </div>
        </div>
        <div id="image-lg-modal" class="modal fade in" role="dialog">
            <div class="modal-icons">
                <button type="button" class="close-view" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="img"></div>
            </div>
        </div>
        <script>
            $(".star-rating input").change(function(e) {
                $(".star").each(function(i) {
                    $(this).css("color", i < e.target.value ? "rgb(240, 230, 140)" : "");
                });
            });

            $("#new-review-form").submit(function(e) {
                e.preventDefault();
                var btnController = new submitBtnController(this);
                $.post(this.action, $(this).serializeArray(), function(result) {
                    alert(result);
                    $(".star").css("color", "");
                    $(".clear-uploads").click();
                    location.reload();
                }).fail(function(err) {
                    alert(err.responseText);
                }).always(function() {
                    btnController.finish();
                });
            });

            $(".images img").click(function() {
                var img = $(this).attr("src");
                $("#image-lg-modal .img").css("background-image", "url(" + img + ")");
            })
        </script>
    </section>
<%- include ('partials/footer') -%>