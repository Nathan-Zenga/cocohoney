<%- include ('partials/header') -%>
<div class="profile-body">
    <div class="container">
        <div class="row">
            <div class="col-sm-5">
                <div class="row">
                    <div class="col-sm-12 profile-card">
                        <div class="profile-picture" style="background-image: url('<%- (user.image || {}).url %>');"></div>
                        <div class="profile-summary">
                            <p class="name"><%- user.firstname %> <%- user.lastname %></p>
                            <button class="minimal" type="button" id="settings-button" data-toggle="modal" data-target="#settings-modal">
                                <span>SETTINGS</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 dashboard">
                <div class="nav-pills-container">
                    <ul class="nav nav-pills">
                        <li class="active"><a data-toggle="pill" href="#history">PURCHASE HISTORY</a></li>
                        <li><a data-toggle="pill" href="#wishlist">WISH LIST</a></li>
                    </ul>
                </div>
                <div class="tab-content" style="padding: 0;">
                    <div id="history" class="tab-pane fade in active">
                        <div class="thumb-container no-wrap">
                            <div class="<%- orders.length ? 'container' : '' %>" style="<%- orders.length ? 'padding: 20px 0 20px 30px;' : '' %>">
                                <div class="row">
                                    <%_ if (!orders.length) { _%>
                                    <div id="order-sales-counter"><h1>0 <small>ORDERS MADE</small></h1></div>
                                    <%_ } orders.forEach((order, i, arr) => { _%>
                                    <div class="thumb">
                                        <div class="thumb-inner">
                                            <div class="thumb-info">
                                                <div class="order-header">
                                                    <div class="row">
                                                        <div class="col-sm-6 order-name"><p>Order # <%- arr.length - i %></p></div>
                                                        <%_ const day = order.created_at.getDate(); _%>
                                                        <%_ const month = order.created_at.getMonth() + 1; _%>
                                                        <%_ const year = order.created_at.getFullYear(); _%>
                                                        <div class="col-sm-6 order-date">
                                                            <p><%= `${ day < 10 ? "0"+day : day }/${ month < 10 ? "0"+month : month }/${ year }` %></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="order-summary">
                                                    <ul>
                                                        <%_ const list_filtered = order.cart.slice(0, 3); _%>
                                                        <%_ const info_overflow = order.cart.length > list_filtered.length; _%>
                                                        <%_ list_filtered.forEach((item, i, arr) => { _%>
                                                        <li><%- item.qty %> x <%- item.name %></li>
                                                        <%_ }) _%>
                                                        <%- info_overflow ? "..." : "" %>
                                                    </ul>
                                                </div>
                                                <div class="order-summary-link">
                                                    <a href="/order/<%- order.id %>">VIEW DETAILS</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <%_ }) _%>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="wishlist" class="tab-pane fade">
                        <div class="thumb-container no-wrap">
                            <div class="<%- wishlist.length ? 'container' : '' %>" style="<%- wishlist.length ? 'padding: 20px 0 20px 30px;' : '' %>">
                                <div class="row">
                                    <%_ if (!wishlist.length) { _%>
                                    <div id="order-sales-counter"><h1>EMPTY WISHLIST</h1></div>
                                    <%_ } wishlist.forEach((product, i, arr) => { _%>
                                    <div class="thumb">
                                        <div class="thumb-inner">
                                            <a href="/product/<%= product.category + '/' + product.name %>">
                                                <div class="thumb-img product-image<%= product.stock_qty < 1 ? ' sold-out' : '' %>" style="background-image: url('<%- product.image ? product.image.url : '' %>');">
                                                    <%_ if (product.price_sale) { _%>
                                                    <div class="sale-ribbon">SALE</div>
                                                    <%_ } _%>
                                                </div>
                                            </a>
                                            <div class="thumb-info">
                                                <div class="product-name"><p><%= product.name %></p></div>
                                                <%_ const price = sale_sitewide || sale && product.price_sale ? product.price_sale : product.price; _%>
                                                <div class="product-price"><p>Â£<%- (price / 100).toFixed(2) %></p></div>
                                                <div class="cart-options">
                                                    <%_ if (product.stock_qty > 0) { _%>
                                                    <form class="add-to-cart minimal">
                                                        <div class="quantity-wrapper">
                                                            <button type="button" class="quantity-control-btn" data-step="-1">-</button>
                                                            <input class="product-quantity" type="number" name="quantity" min="1" max="<%= product.stock_qty %>" value="1">
                                                            <button type="button" class="quantity-control-btn" data-step="1">+</button>
                                                        </div>
                                                        <input type="hidden" name="id" value="<%- product.id %>">
                                                        <%_ if (product.pre_release) { _%>
                                                        <button formaction="/shop/cart/add" class="add-to-cart-btn pre-order">PRE-ORDER</button>
                                                        <%_ } else { _%>
                                                        <button formaction="/shop/cart/add" class="add-to-cart-btn"><i class="fal fa-cart-arrow-down"></i></button>
                                                        <%_ } _%>
                                                        <button formaction="/wishlist/remove" class="add-to-cart-btn wishlist-remove"><i class="fal fa-trash-alt"></i></button>
                                                    </form>
                                                    <%_ } else { _%>
                                                    <div class="sold-out-label">SOLD OUT</div>
                                                    <%_ } _%>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <%_ }) _%>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal fade in" role="dialog">
    <div class="modal-icons">
        <button type="button" class="close-view" data-dismiss="modal">&times;</button>
    </div>
    <div class="modal-body">
        <ul class="nav nav-pills">
            <li class="active"><a data-toggle="pill" href="#personal-details-settings">EDIT PROFILE</a></li>
            <li><a data-toggle="pill" href="#account-settings">ACCOUNT</a></li>
        </ul>
        <div class="tab-content">
            <div id="personal-details-settings" class="tab-pane fade in active">
                <form method="post" action="/account/edit" id="personal-details-edit-form">
                    <label>PROFILE PICTURE</label>
                    <fieldset class="file-upload-container" style="margin-bottom: 1em">
                        <div class="row">
                            <div class="col-sm-6 col-xs-9"><input type="file" id="profile_picture_file" accept=".jpg,.jpeg,.png,.bmp" data-fieldname="image_file"></div>
                            <input type="hidden" name="image_file">
                            <div class="col-sm-6 col-xs-3"><button type="button" class="clear-uploads" data-id="profile_picture_file">CLEAR</button></div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12"><input type="url" name="image_url" id="profile_picture_url" placeholder="Or paste the image URL"></div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <div class="row">
                            <div class="col-sm-6">
                                <label>FIRST NAME</label>
                                <input type="text" name="firstname" value="<%- user.firstname %>">
                            </div>
                            <div class="col-sm-6">
                                <label>LAST NAME</label>
                                <input type="text" name="lastname" value="<%- user.lastname %>">
                            </div>
                        </div>
                    </fieldset>

                    <label>PHONE NUMBER</label>
                    <input type="tel" name="phone_number" value="<%- user.phone_number %>">

                    <label>EMAIL</label>
                    <input type="email" name="email" value="<%- user.email %>">

                    <input type="hidden" name="id" value="<%= user._id %>">
                    <input type="submit" value="UPDATE">
                </form>
            </div>

            <div id="account-settings" class="tab-pane fade">
                <div class="form-container">
                    <form class="minimal" method="post" action="/account/edit" id="mail-sub-toggle" style="text-align: center; padding: 0 30px">
                        <input type="hidden" name="id" value="<%= user._id %>">
                        <input type="checkbox" name="mail_sub" value="true" <%- user.mail_sub ? 'checked' : '' %>> <b>Recieve emails?</b> (for updates, promotions etc.)
                    </form>
                    <form class="minimal sensitive-form" method="post" action="/account/delete">
                        <input type="hidden" name="id" value="<%- user._id %>">
                        <button type="submit" class="btn-danger">DELETE ACCOUNT</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $("#personal-details-edit-form").submit(function(e) {
        e.preventDefault();
        var btnController = new submitBtnController(this);
        $.post(this.action, $(this).serializeArray(), function(result) {
            alert(result);
            location.reload();
        }).fail(function(err) {
            btnController.finish();
            alert(err.responseText);
        });
    });

    $("#mail-sub-toggle input:checkbox").change(function(e) {
        e.preventDefault();
        var form = $(this).parent("form").get(0);
        var data = $(form).serializeArray().slice();
        $(this).attr("disabled", true);
        $.post(form.action, data, function(result) {
            alert(result);
        }).fail(function(err) {
            alert(err.responseText);
        }).always(function() {
            $(e.target).attr("disabled", false);
        });
    });

    $(".sensitive-form").off("submit").submit(function(e) {
        e.preventDefault();
        var confirmation = confirm("Are you sure?");
        if (confirmation) {
            var btnController = new submitBtnController(this);
            $.post(this.action, $(this).serializeArray(), function(result) {
                alert(result);
                location.reload();
            }).fail(function(err) {
                btnController.finish();
                alert(err.responseText);
            });
        }
    });
</script>
<%- include ('partials/footer') -%>