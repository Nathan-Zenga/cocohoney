<%_ include partials/header _%>
    <%_ include partials/stripe-checkout-css _%>
    <div id="payment-form-container" style="margin-top: 2em">
        <div class="content container">
            <ul class="nav nav-pills">
                <li class="active"><a data-toggle="pill" href="#card-payment">
                    <span class="btn-label"><i class="icon fal fa-credit-card"></i> <span>CARD</span></span>
                </a></li>
                <li><a data-toggle="pill" href="#paypal-payment">
                    <span class="btn-label"><i class="icon fab fa-paypal"></i> <span>PAYPAL</span></span>
                </a></li>
            </ul>

            <div class="tab-content">
                <div id="card-payment" class="tab-pane fade in active">
                    <form id="payment-details-form" action="/shop/checkout/payment-intent/create">
                        <fieldset>
                            <div class="row">
                                <div class="col-sm-6">
                                    <label for="firstname">FIRST NAME</label>
                                    <input type="text" name="firstname" id="firstname" required>
                                </div>
                                <div class="col-sm-6">
                                    <label for="lastname">LAST NAME</label>
                                    <input type="text" name="lastname" id="lastname" required>
                                </div>
                            </div>
                        </fieldset>
                        <label for="email">EMAIL</label>
                        <input type="email" name="email" id="email" required>
                        <label for="address_l1">ADDRESS</label>
                        <input type="text" name="address_l1" id="address_l1" placeholder="LINE 1" required>
                        <input type="text" name="address_l2" id="address_l2" placeholder="LINE 2 (OPTIONAL)">
                        <fieldset>
                            <div class="row">
                                <div class="col-sm-4">
                                    <label for="city">CITY</label>
                                    <input type="text" name="city" id="city" required>
                                </div>
                                <div class="col-sm-4">
                                    <label for="country">COUNTRY <i class="dropdown-arrow fal fa-chevron-down"></i></label>
                                    <select name="country" id="country" required>
                                        <option value="">-</option>
                                        <%_ for (var k in countries) { _%>
                                        <option value="<%- k %>"><%- countries[k] %></option>
                                        <%_ } _%>
                                    </select>
                                </div>
                                <div class="col-sm-4">
                                    <label for="postcode">POST / ZIP CODE</label>
                                    <input type="text" name="postcode" id="postcode" required>
                                </div>
                            </div>
                        </fieldset>
                        <br>
                        <label for="discount_code">DISCOUNT CODE</label>
                        <input type="text" name="discount_code" id="discount_code">
                        <label>CHOOSE DELIVERY METHOD</label><br><br>
                        <%_ shipping_fees.forEach(fee => { _%>
                        <input type="radio" name="shipping_fee_id" value="<%= fee.id %>" required>
                            <%= fee.name %> (£<%= (fee.fee / 100).toFixed(2) %>)<%- fee.info ? ' <small>' + fee.info + '</small>' : '' %>
                        <br>
                        <%_ }) _%>
                        <br><br>
                        <button class="checkout-btn" type="submit">
                            <span class="btn-label"><i class="icon fal fa-credit-card"></i> <span>CONTINUE TO PAYMENT</span></span>
                        </button>
                    </form>

                    <form class="minimal" id="card-payment-form" style="display: none; margin-top: 2em">
                        <label for="card-element">ENTER PAYMENT DETAILS</label>
                        <div id="card-element"></div>
                        <input type="submit" id="submit-payment-btn" value="PAY">

                        <p id="card-error" role="alert"></p>
                    </form>
                </div>

                <div id="paypal-payment" class="tab-pane fade">
                    <form id="paypal-payment-form" action="/shop/checkout/paypal/create-payment">
                        <label for="discount_code">DISCOUNT CODE</label>
                        <input type="text" name="discount_code" id="discount_code">
                        <label>CHOOSE DELIVERY METHOD</label><br><br>
                        <%_ shipping_fees.forEach(fee => { _%>
                        <input type="radio" name="shipping_fee_id" value="<%= fee.id %>" required>
                            <%= fee.name %> (£<%= (fee.fee / 100).toFixed(2) %>)<%- fee.info ? ' <small>' + fee.info + '</small>' : '' %>
                        <br>
                        <%_ }) _%>
                        <br><br>
                        <button class="checkout-btn" type="submit">
                            <span class="btn-label"><i class="icon fab fa-paypal"></i> <span>CONTINUE TO PAYMENT</span></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        window.onbeforeunload = function() { return true };
        $("#paypal-payment-form").submit(function(e) {
            e.preventDefault();
            window.onbeforeunload = null;
            $.post(this.action, $(this).serializeArray(), function(href) {
                location.href = href;
            }).fail(function(err, status, codeMessage) {
                window.onbeforeunload = function() { return true };
                alert(codeMessage + (err ? ": " + err.responseText : ""));
            });
        });

        $("#payment-details-form").submit(function(e) {
            e.preventDefault();
            var btnControl = new submitBtnController(this);
            $.post(this.action, $(this).serializeArray(), function(data) {
                var stripe = Stripe(data.pk);
                $(":input, button", e.target).attr("disabled", true).filter(":submit").remove();
                $("#submit-payment-btn").attr("disabled", true);
                $("#card-payment-form").show(0, function() {
                    $("html, body").animate({ scrollTop: $(this).offset().top - 100 });
                    var card = stripe.elements().create("card", { style: {
                        base: { // input fields
                            color: "#32325d",
                            fontFamily: 'Arial, sans-serif',
                            fontSmoothing: "antialiased",
                            fontSize: "16px",
                            "::placeholder": { color: "#32325d" }
                        },
                        invalid: { // input fields (invalid)
                            fontFamily: 'Arial, sans-serif',
                            color: "#fa755a",
                            iconColor: "#fa755a"
                        }
                    }});
                    card.mount("#card-element"); // Stripe injects an iframe into the DOM
                    card.on("change", function(e) {
                        // Disable the Pay button if there are no card details in the Element
                        $("#submit-payment-btn").attr("disabled", e.empty);
                        $("#card-error").prop("textContent", e.error ? e.error.message : "");
                    });
                    btnControl.finish();

                    $("#card-payment-form").submit(function(e) {
                        e.preventDefault();
                        // Complete payment when the submit button is clicked
                        var btnControl = new submitBtnController(this);
                        $("#submit-payment-btn").attr("disabled", true);
                        stripe.confirmCardPayment(data.clientSecret, { payment_method: { card } }).then(function(res) {
                            $("#submit-payment-btn").attr("disabled", false);
                            if (res.error) return btnControl.finish(), showError(res.error.message);
                            window.onbeforeunload = null;
                            $("#cart-item-count").text(0);
                            $.post("/shop/checkout/payment-intent/complete", function(msg) {
                                $("html, body").animate({ scrollTop: 0 }, function() {
                                    $(".content > *").fadeOut(function() {
                                        var css = { display: "none", marginTop: "5em", textAlign: "center", fontWeight: 400 };
                                        $(".content").html($("<div>").css(css).html(msg).get(0).outerHTML).children().fadeIn();
                                    });
                                });
                            }).fail(function(err, status, codeMessage) {
                                alert(codeMessage + (err ? ": " + err.responseText : ""));
                            }).always(function() {
                                btnControl.finish();
                            });
                        });
                    });
                });
            }).fail(function(err, status, codeMessage) {
                btnControl.finish();
                alert(codeMessage + (err ? ": " + err.responseText : ""));
            });

            var showError = function(errorMsgText) {
                // Show the customer the error from Stripe if their card fails to charge
                var errorMsg = $("#card-error").get(0);
                errorMsg.textContent = errorMsgText;
                setTimeout(function() { errorMsg.textContent = "" }, 4000);
            };
        })
    </script>
<%_ include partials/footer _%>